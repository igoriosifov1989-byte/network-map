# Testing Guide

Этот документ описывает все тесты в проекте DiagramFlow и как их запускать.

## Обзор тестов

Проект включает комплексный набор тестов, покрывающий все основные функции:

### Frontend тесты (client/src/test/)
- **utils.test.ts** - Тесты вспомогательных функций (className utility)
- **diagramUtils.test.ts** - Тесты алгоритмов компоновки диаграмм
- **eventProcessor.test.ts** - Тесты обработки сетевых событий
- **components.test.tsx** - Тесты React компонентов (Statistics, TraceList)
- **integration.test.tsx** - Интеграционные тесты всего приложения

### Backend тесты (server/test/)
- **api.test.ts** - Тесты API маршрутов и HTTP endpoints

## Запуск тестов

### Все тесты
```bash
npx vitest
```

### Запуск тестов один раз
```bash
npx vitest run
```

### Только клиентские тесты
```bash
npx vitest run client/src/test
```

### Только серверные тесты
```bash
npx vitest run server/test
```

### Тесты с отслеживанием изменений
```bash
npx vitest --watch
```

### Тесты с покрытием кода
```bash
npx vitest run --coverage
```

## Что тестируется

### 1. Алгоритмы компоновки диаграмм
- Force layout (силовая компоновка)
- Circular layout (круговая компоновка)
- Grid layout (сетчатая компоновка)
- Hierarchical layout (иерархическая компоновка)
- Валидация входных данных
- Обработка пустых данных

### 2. Обработка сетевых событий
- Преобразование событий в формат диаграммы
- Агрегация счетчиков соединений
- Отслеживание HTTP статус кодов
- Группировка по trace ID
- Вычисление статистики
- Объединение данных из файлов и real-time

### 3. React компоненты
- **Statistics** - отображение HTTP статистики, фильтрация соединений
- **TraceList** - список trace ID, выбор/снятие выбора
- Обработка пустых данных
- Взаимодействие пользователя

### 4. Интеграционные тесты
- Рендеринг основного приложения
- Выбор trace и подсветка элементов
- Переключение режимов отображения
- Экспорт диаграмм
- Справочная панель
- Real-time контроллы
- Адаптивный дизайн

### 5. API тесты
- **Диаграммы**: CRUD операции (создание, чтение, обновление, удаление)
- **Сетевые события**: получение в диапазоне времени, лимиты
- **Генерация событий**: запуск/остановка real-time генерации
- **Загрузка файлов**: CSV/Excel парсинг, валидация, множественные файлы
- **Обработка ошибок**: 404, некорректный JSON, валидация
- **CORS и заголовки**

### 6. Вспомогательные функции
- Объединение CSS классов (className utility)
- Условные классы
- Обработка undefined/null значений

## Конфигурация тестов

### Vitest настройка
- Использует jsdom environment для DOM тестов
- Настроен alias для путей (@, @shared, @assets)
- Глобальные переменные для тестов
- Автоматическая очистка после каждого теста

### Моки
- **Three.js** - предотвращает WebGL ошибки в тестах
- **Browser APIs** - matchMedia, ResizeObserver, URL.createObjectURL
- **QueryClient** - для React Query тестов

## Структура файлов

```
client/src/test/
├── setup.ts              # Конфигурация тестового окружения
├── utils.test.ts          # Тесты вспомогательных функций
├── diagramUtils.test.ts   # Тесты алгоритмов диаграмм
├── eventProcessor.test.ts # Тесты обработки событий
├── components.test.tsx    # Тесты React компонентов
└── integration.test.tsx   # Интеграционные тесты

server/test/
└── api.test.ts           # Тесты API endpoints

vitest.config.ts          # Конфигурация Vitest
```

## Покрытие кода

Тесты покрывают основные функции:
- ✅ Алгоритмы компоновки диаграмм
- ✅ Обработка и преобразование данных
- ✅ React компоненты и их взаимодействие
- ✅ API endpoints и маршруты
- ✅ Обработка ошибок
- ✅ Валидация данных
- ✅ Real-time функционал
- ✅ Файловые операции

## Известные ограничения

1. **3D рендеринг** - Three.js WebGL не может быть полностью протестирован в Node.js окружении
2. **Файловая загрузка** - Тесты используют моки для multer file upload
3. **WebSocket** - Real-time соединения тестируются через HTTP API

## Добавление новых тестов

### Для новых компонентов:
1. Создайте файл в `client/src/test/`
2. Используйте TestWrapper для QueryClient
3. Мокайте внешние зависимости
4. Тестируйте основной функционал и граничные случаи

### Для новых API:
1. Добавьте тесты в `server/test/api.test.ts`
2. Используйте supertest для HTTP запросов
3. Тестируйте успешные и ошибочные сценарии
4. Проверяйте валидацию данных

## Автоматизация

Тесты можно интегрировать в CI/CD:
```bash
# Проверка всех тестов
npm run test:run

# С покрытием кода
npm run test:coverage
```

Все тесты должны проходить перед деплоем в production.